name: Collect Steam & Unemployment Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      collect_fred:
        description: 'Also collect FRED data'
        required: false
        default: 'false'

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install pandas pyarrow requests

    - name: Download existing data
      uses: actions/download-artifact@v4
      with:
        name: steam-data-latest
        path: data/raw
      continue-on-error: true

    - name: Collect Steam data
      env:
        COLLECT_FRED: ${{ github.event.inputs.collect_fred || 'false' }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: python collect_simple.py

    - name: Upload latest data
      uses: actions/upload-artifact@v4
      with:
        name: steam-data-latest
        path: data/raw/*.parquet
        retention-days: 90
        overwrite: true

    - name: Summary
      if: always()
      run: |
        echo "## Collection Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Run #${{ github.run_number }}** at $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "data/raw/steam_hourly.parquet" ]; then
          SIZE=$(python -c "import pandas as pd; df=pd.read_parquet('data/raw/steam_hourly.parquet'); print(len(df))")
          echo "✅ Steam data: $SIZE records" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ No Steam data file" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "data/raw/unemployment.parquet" ]; then
          SIZE=$(python -c "import pandas as pd; df=pd.read_parquet('data/raw/unemployment.parquet'); print(len(df))")
          echo "✅ FRED data: $SIZE records" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No unemployment data" >> $GITHUB_STEP_SUMMARY
        fi
